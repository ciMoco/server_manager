<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœåŠ¡å™¨æ‰¹é‡ç®¡ç†å¹³å°</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 0;
        }

        .main-container {
            max-width: 1200px;
            margin: 30px auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background-color: #2c3e50;
            color: white;
            text-align: center;
            padding: 30px 0;
        }

        .header h1 {
            margin: 0;
            font-size: 36px;
        }

        .header p {
            margin-top: 10px;
            font-size: 18px;
            opacity: 0.8;
        }

        .nav {
            display: flex;
            background-color: #34495e;
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 15px 0;
            color: white;
            text-decoration: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .nav-item:hover {
            background-color: #2c3e50;
        }

        .nav-item.active {
            background-color: #2c3e50;
            border-bottom: 3px solid #3498db;
        }

        .tab-content {
            padding: 30px;
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .server-list {
            margin-top: 20px;
        }

        .server-card {
            background-color: #ecf0f1;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .server-card h3 {
            margin: 0;
        }

        .server-actions {
            display: flex;
            gap: 10px;
        }

        .result-container {
            margin-top: 20px;
        }

        .result-item {
            background-color: #ecf0f1;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
        }

        .result-item h4 {
            margin: 0 0 10px 0;
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 5px;
        }
    </style>
</head>

<body>
    <div class="main-container">
        <div class="header">
            <h1>ğŸ–¥ï¸ æœåŠ¡å™¨æ‰¹é‡ç®¡ç†å¹³å°</h1>
            <p>é«˜æ•ˆç®¡ç†å¤šå°æœåŠ¡å™¨ï¼Œæ‰¹é‡æ‰§è¡Œå‘½ä»¤</p>
        </div>
        <div class="nav">
            <div class="nav-item active" onclick="switchTab('servers')">æœåŠ¡å™¨ç®¡ç†</div>
            <div class="nav-item" onclick="switchTab('execute')">æ‰¹é‡æ‰§è¡Œ</div>
            <div class="nav-item" onclick="switchTab('tasks')">ä»»åŠ¡å†å²</div>
            <div class="nav-item" onclick="switchTab('templates')">å‘½ä»¤æ¨¡æ¿</div>
            <div class="nav-item" onclick="switchTab('scheduled')">å®šæ—¶ä»»åŠ¡</div>
        </div>
        <div class="content">
            <!-- æœåŠ¡å™¨ç®¡ç† -->
            <div id="servers" class="tab-content active">
                <h2>æ·»åŠ æœåŠ¡å™¨</h2>
                <form id="serverForm">
                    <div class="form-group">
                        <label for="serverName">æœåŠ¡å™¨åç§°</label>
                        <input type="text" id="serverName" required>
                    </div>
                    <div class="form-group">
                        <label for="serverHost">ä¸»æœºåœ°å€</label>
                        <input type="text" id="serverHost" required>
                    </div>
                    <div class="form-group">
                        <label for="serverPort">ç«¯å£</label>
                        <input type="number" id="serverPort" value="22" required>
                    </div>
                    <div class="form-group">
                        <label for="serverUsername">ç”¨æˆ·å</label>
                        <input type="text" id="serverUsername" required>
                    </div>
                    <div class="form-group">
                        <label for="serverPassword">å¯†ç </label>
                        <input type="password" id="serverPassword" required>
                    </div>
                    <div class="form-group">
                        <label for="serverDescription">æè¿°</label>
                        <input type="text" id="serverDescription">
                    </div>
                    <button type="submit" class="btn btn-primary">æ·»åŠ æœåŠ¡å™¨</button>
                </form>
                <h2 style="margin-top: 40px;">æœåŠ¡å™¨åˆ—è¡¨</h2>
                <div id="serverList" class="server-list"></div>
            </div>
            <!-- æ‰¹é‡æ‰§è¡Œ -->
            <div id="execute" class="tab-content">
                <h2>æ‰¹é‡æ‰§è¡Œå‘½ä»¤</h2>
                <form id="executeForm">
                    <div class="form-group">
                        <label for="taskName">ä»»åŠ¡åç§°</label>
                        <input type="text" id="taskName" required>
                    </div>
                    <div class="form-group">
                        <label for="command">æ‰§è¡Œå‘½ä»¤</label>
                        <textarea id="command" rows="4" required placeholder="ä¾‹å¦‚: df -h && free -m"></textarea>
                    </div>
                    <div class="form-group">
                        <label>é€‰æ‹©æœåŠ¡å™¨</label>
                        <div id="serverSelector" class="checkbox-group"></div>
                    </div>
                    <button type="submit" class="btn btn-primary">æ‰§è¡Œå‘½ä»¤</button>
                </form>
                <div id="executeResults" class="result-container"></div>
            </div>
            <!-- ä»»åŠ¡å†å² -->
            <div id="tasks" class="tab-content">
                <h2>ä»»åŠ¡å†å²</h2>
                <div id="taskHistory"></div>
            </div>
            <!-- å‘½ä»¤æ¨¡æ¿ -->
            <div id="templates" class="tab-content">
                <h2>åˆ›å»ºå‘½ä»¤æ¨¡æ¿</h2>
                <form id="templateForm">
                    <div class="form-group">
                        <label for="templateName">æ¨¡æ¿åç§°</label>
                        <input type="text" id="templateName" required>
                    </div>
                    <div class="form-group">
                        <label for="templateCommand">å‘½ä»¤å†…å®¹</label>
                        <textarea id="templateCommand" rows="4" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="templateCategory">åˆ†ç±»</label>
                        <input type="text" id="templateCategory" value="general">
                    </div>
                    <div class="form-group">
                        <label for="templateDescription">æè¿°</label>
                        <input type="text" id="templateDescription">
                    </div>
                    <button type="submit" class="btn btn-primary">åˆ›å»ºæ¨¡æ¿</button>
                </form>
                <h2 style="margin-top: 40px;">å‘½ä»¤æ¨¡æ¿åˆ—è¡¨</h2>
                <div id="templateList" class="server-list"></div>
            </div>
            <!-- å®šæ—¶ä»»åŠ¡ -->
            <div id="scheduled" class="tab-content">
                <h2>åˆ›å»ºå®šæ—¶ä»»åŠ¡</h2>
                <form id="scheduledForm">
                    <div class="form-group">
                        <label for="scheduledTaskName">ä»»åŠ¡åç§°</label>
                        <input type="text" id="scheduledTaskName" required>
                    </div>
                    <div class="form-group">
                        <label for="scheduledCommand">æ‰§è¡Œå‘½ä»¤</label>
                        <textarea id="scheduledCommand" rows="4" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>é€‰æ‹©æœåŠ¡å™¨</label>
                        <div id="scheduledServerSelector" class="checkbox-group"></div>
                    </div>
                    <div class="form-group">
                        <label for="cronExpression">Cronè¡¨è¾¾å¼</label>
                        <input type="text" id="cronExpression" required placeholder="ä¾‹å¦‚: 0 0 * * *">
                    </div>
                    <button type="submit" class="btn btn-primary">åˆ›å»ºå®šæ—¶ä»»åŠ¡</button>
                </form>
                <h2 style="margin-top: 40px;">å®šæ—¶ä»»åŠ¡åˆ—è¡¨</h2>
                <div id="scheduledTaskList" class="server-list"></div>
            </div>
        </div>
    </div>
    <script>
        const API_BASE = 'http://localhost:8000';
        let servers = [];
        let selectedServers = [];

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadServers();
            loadCommandTemplates();
            loadScheduledTasks();
            loadTaskHistory();

            document.getElementById('serverForm').addEventListener('submit', addServer);
            document.getElementById('executeForm').addEventListener('submit', executeCommand);
            document.getElementById('templateForm').addEventListener('submit', createCommandTemplate);
            document.getElementById('scheduledForm').addEventListener('submit', createScheduledTask);
        });

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`.nav-item[onclick="switchTab('${tabName}')"]`).classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'execute') {
                updateServerSelector();
            } else if (tabName === 'scheduled') {
                updateScheduledServerSelector();
            } else if (tabName === 'tasks') {
                loadTaskHistory();
            }
        }

        // åŠ è½½æœåŠ¡å™¨åˆ—è¡¨
        async function loadServers() {
            try {
                const response = await fetch(`${API_BASE}/api/servers/`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                servers = await response.json();
                updateServerList();
                updateServerSelector();
                updateScheduledServerSelector();
            } catch (error) {
                console.error('åŠ è½½æœåŠ¡å™¨åˆ—è¡¨å¤±è´¥:', error);
                showAlert('åŠ è½½æœåŠ¡å™¨åˆ—è¡¨å¤±è´¥', 'error');
            }
        }

        // æ›´æ–°æœåŠ¡å™¨åˆ—è¡¨æ˜¾ç¤º
        function updateServerList() {
            const container = document.getElementById('serverList');
            if (servers.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #777; padding: 20px;">æš‚æ— æœåŠ¡å™¨</p>';
                return;
            }
            container.innerHTML = servers.map(server => `
                <div class="server-card">
                    <div>
                        <h3>${server.name}</h3>
                        <p><strong>åœ°å€:</strong> ${server.host}:${server.port} | <strong>ç”¨æˆ·:</strong> ${server.username}</p>
                        ${server.description ? `<p><strong>æè¿°:</strong> ${server.description}</p>` : ''}
                    </div>
                    <div class="server-actions">
                        <button class="btn btn-danger" onclick="deleteServer(${server.id})">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        // æ›´æ–°æœåŠ¡å™¨é€‰æ‹©å™¨
        function updateServerSelector() {
            const container = document.getElementById('serverSelector');
            container.innerHTML = servers.map(server => `
                <label>
                    <input type="checkbox" value="${server.id}" onchange="updateSelectedServers()">
                    ${server.name} (${server.host})
                </label>
            `).join('');
        }

        // æ›´æ–°é€‰ä¸­çš„æœåŠ¡å™¨
        function updateSelectedServers() {
            selectedServers = Array.from(document.querySelectorAll('#serverSelector input:checked')).map(checkbox => parseInt(checkbox.value));
        }

        // æ·»åŠ æœåŠ¡å™¨
        async function addServer(event) {
            event.preventDefault();
            const serverData = {
                name: document.getElementById('serverName').value,
                host: document.getElementById('serverHost').value,
                port: parseInt(document.getElementById('serverPort').value),
                username: document.getElementById('serverUsername').value,
                password: document.getElementById('serverPassword').value,
                description: document.getElementById('serverDescription').value
            };
            
            try {
                const response = await fetch(`${API_BASE}/api/servers/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(serverData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showAlert('æœåŠ¡å™¨æ·»åŠ æˆåŠŸ!', 'success');
                    document.getElementById('serverForm').reset();
                    loadServers();
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'æ·»åŠ å¤±è´¥');
                }
            } catch (error) {
                console.error('æ·»åŠ æœåŠ¡å™¨å¤±è´¥:', error);
                showAlert(`æ·»åŠ æœåŠ¡å™¨å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åˆ é™¤æœåŠ¡å™¨
        async function deleteServer(serverId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™å°æœåŠ¡å™¨å—ï¼Ÿ')) return;
            try {
                const response = await fetch(`${API_BASE}/api/servers/${serverId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showAlert('æœåŠ¡å™¨åˆ é™¤æˆåŠŸ!', 'success');
                    loadServers();
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                console.error('åˆ é™¤æœåŠ¡å™¨å¤±è´¥:', error);
                showAlert(`åˆ é™¤æœåŠ¡å™¨å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ‰§è¡Œå‘½ä»¤
        async function executeCommand(event) {
            event.preventDefault();
            if (selectedServers.length === 0) {
                showAlert('è¯·è‡³å°‘é€‰æ‹©ä¸€å°æœåŠ¡å™¨', 'error');
                return;
            }
            const executeData = {
                task_name: document.getElementById('taskName').value,
                command: document.getElementById('command').value,
                server_ids: selectedServers
            };
            const resultsContainer = document.getElementById('executeResults');
            resultsContainer.innerHTML = '<p>æ­£åœ¨æ‰§è¡Œï¼Œè¯·ç¨å€™...</p>';
            try {
                const response = await fetch(`${API_BASE}/api/execute/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(executeData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showExecuteResults(result.results);
                    showAlert(result.message, 'success');
                    document.getElementById('executeForm').reset();
                    loadTaskHistory();
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'æ‰§è¡Œå¤±è´¥');
                }
            } catch (error) {
                console.error('å‘½ä»¤æ‰§è¡Œå¤±è´¥:', error);
                showAlert(`å‘½ä»¤æ‰§è¡Œå¤±è´¥: ${error.message}`, 'error');
                resultsContainer.innerHTML = '';
            }
        }

        // æ˜¾ç¤ºæ‰§è¡Œç»“æœ
        function showExecuteResults(results) {
            const container = document.getElementById('executeResults');
            container.innerHTML = '<h3>æ‰§è¡Œç»“æœ</h3>' + results.map(result => `
                <div class="result-item">
                    <h4>${result.server.name} (${result.server.host})</h4>
                    <p><strong>çŠ¶æ€:</strong> ${result.exit_code === 0 ? 'æˆåŠŸ' : 'å¤±è´¥'}</p>
                    <p><strong>è€—æ—¶:</strong> ${result.execution_time} ç§’</p>
                    ${result.output ? `<pre>${result.output}</pre>` : ''}
                    ${result.error ? `<pre style="color: red;">${result.error}</pre>` : ''}
                </div>
            `).join('');
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            const contentDiv = document.querySelector('.content');
            contentDiv.prepend(alertDiv);
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // åŠ è½½å‘½ä»¤æ¨¡æ¿åˆ—è¡¨
        async function loadCommandTemplates() {
            try {
                const response = await fetch(`${API_BASE}/api/templates/`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const templates = await response.json();
                updateCommandTemplateList(templates);
            } catch (error) {
                console.error('åŠ è½½å‘½ä»¤æ¨¡æ¿åˆ—è¡¨å¤±è´¥:', error);
                showAlert('åŠ è½½å‘½ä»¤æ¨¡æ¿åˆ—è¡¨å¤±è´¥', 'error');
            }
        }

        // æ›´æ–°å‘½ä»¤æ¨¡æ¿åˆ—è¡¨æ˜¾ç¤º
        function updateCommandTemplateList(templates) {
            const container = document.getElementById('templateList');
            if (templates.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #777; padding: 20px;">æš‚æ— å‘½ä»¤æ¨¡æ¿</p>';
                return;
            }
            container.innerHTML = templates.map(template => `
                <div class="server-card">
                    <div>
                        <h3>${template.name}</h3>
                        <p><strong>å‘½ä»¤:</strong> ${template.command}</p>
                        <p><strong>åˆ†ç±»:</strong> ${template.category}</p>
                        ${template.description ? `<p><strong>æè¿°:</strong> ${template.description}</p>` : ''}
                    </div>
                    <div class="server-actions">
                        <button class="btn btn-danger" onclick="deleteCommandTemplate(${template.id})">åˆ é™¤</button>
                        <button class="btn btn-primary" onclick="useCommandTemplate(${template.id})">ä½¿ç”¨</button>
                    </div>
                </div>
            `).join('');
        }

        // ä½¿ç”¨å‘½ä»¤æ¨¡æ¿
        async function useCommandTemplate(templateId) {
            try {
                const response = await fetch(`${API_BASE}/api/templates/${templateId}/`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const template = await response.json();
                document.getElementById('command').value = template.command;
                switchTab('execute');
            } catch (error) {
                console.error('åŠ è½½å‘½ä»¤æ¨¡æ¿å¤±è´¥:', error);
                showAlert('åŠ è½½å‘½ä»¤æ¨¡æ¿å¤±è´¥', 'error');
            }
        }

        // åˆ›å»ºå‘½ä»¤æ¨¡æ¿
        async function createCommandTemplate(event) {
            event.preventDefault();
            const templateData = {
                name: document.getElementById('templateName').value,
                command: document.getElementById('templateCommand').value,
                category: document.getElementById('templateCategory').value,
                description: document.getElementById('templateDescription').value
            };
            try {
                const response = await fetch(`${API_BASE}/api/templates/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(templateData)
                });
                
                if (response.ok) {
                    showAlert('å‘½ä»¤æ¨¡æ¿åˆ›å»ºæˆåŠŸ!', 'success');
                    document.getElementById('templateForm').reset();
                    loadCommandTemplates();
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'åˆ›å»ºå¤±è´¥');
                }
            } catch (error) {
                console.error('åˆ›å»ºå‘½ä»¤æ¨¡æ¿å¤±è´¥:', error);
                showAlert(`åˆ›å»ºå‘½ä»¤æ¨¡æ¿å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åˆ é™¤å‘½ä»¤æ¨¡æ¿
        async function deleteCommandTemplate(templateId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå‘½ä»¤æ¨¡æ¿å—ï¼Ÿ')) return;
            try {
                const response = await fetch(`${API_BASE}/api/templates/${templateId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showAlert('å‘½ä»¤æ¨¡æ¿åˆ é™¤æˆåŠŸ!', 'success');
                    loadCommandTemplates();
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                console.error('åˆ é™¤å‘½ä»¤æ¨¡æ¿å¤±è´¥:', error);
                showAlert(`åˆ é™¤å‘½ä»¤æ¨¡æ¿å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ›´æ–°å®šæ—¶ä»»åŠ¡æœåŠ¡å™¨é€‰æ‹©å™¨
        function updateScheduledServerSelector() {
            const container = document.getElementById('scheduledServerSelector');
            container.innerHTML = servers.map(server => `
                <label>
                    <input type="checkbox" value="${server.id}" onchange="updateScheduledSelectedServers()">
                    ${server.name} (${server.host})
                </label>
            `).join('');
        }

        // æ›´æ–°é€‰ä¸­çš„å®šæ—¶ä»»åŠ¡æœåŠ¡å™¨
        function updateScheduledSelectedServers() {
            selectedServers = Array.from(document.querySelectorAll('#scheduledServerSelector input:checked')).map(checkbox => parseInt(checkbox.value));
        }

        // åˆ›å»ºå®šæ—¶ä»»åŠ¡
        async function createScheduledTask(event) {
            event.preventDefault();
            if (selectedServers.length === 0) {
                showAlert('è¯·è‡³å°‘é€‰æ‹©ä¸€å°æœåŠ¡å™¨', 'error');
                return;
            }
            const scheduledData = {
                name: document.getElementById('scheduledTaskName').value,
                command: document.getElementById('scheduledCommand').value,
                server_ids: selectedServers,
                cron_expression: document.getElementById('cronExpression').value
            };
            try {
                const response = await fetch(`${API_BASE}/api/scheduled/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(scheduledData)
                });
                
                if (response.ok) {
                    showAlert('å®šæ—¶ä»»åŠ¡åˆ›å»ºæˆåŠŸ!', 'success');
                    document.getElementById('scheduledForm').reset();
                    loadScheduledTasks();
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'åˆ›å»ºå¤±è´¥');
                }
            } catch (error) {
                console.error('åˆ›å»ºå®šæ—¶ä»»åŠ¡å¤±è´¥:', error);
                showAlert(`åˆ›å»ºå®šæ—¶ä»»åŠ¡å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åŠ è½½å®šæ—¶ä»»åŠ¡åˆ—è¡¨
        async function loadScheduledTasks() {
            try {
                const response = await fetch(`${API_BASE}/api/scheduled/`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const tasks = await response.json();
                updateScheduledTaskList(tasks);
            } catch (error) {
                console.error('åŠ è½½å®šæ—¶ä»»åŠ¡åˆ—è¡¨å¤±è´¥:', error);
                showAlert('åŠ è½½å®šæ—¶ä»»åŠ¡åˆ—è¡¨å¤±è´¥', 'error');
            }
        }

        // æ›´æ–°å®šæ—¶ä»»åŠ¡åˆ—è¡¨æ˜¾ç¤º
        function updateScheduledTaskList(tasks) {
            const container = document.getElementById('scheduledTaskList');
            if (tasks.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #777; padding: 20px;">æš‚æ— å®šæ—¶ä»»åŠ¡</p>';
                return;
            }
            container.innerHTML = tasks.map(task => `
                <div class="server-card">
                    <div>
                        <h3>${task.name}</h3>
                        <p><strong>å‘½ä»¤:</strong> ${task.command}</p>
                        <p><strong>Cronè¡¨è¾¾å¼:</strong> ${task.cron_expression}</p>
                        <p><strong>çŠ¶æ€:</strong> ${task.is_active ? 'æ´»è·ƒ' : 'å·²ç¦ç”¨'}</p>
                        <p><strong>ä¸‹ä¸€æ¬¡æ‰§è¡Œ:</strong> ${task.next_run_time || 'æœªçŸ¥'}</p>
                    </div>
                    <div class="server-actions">
                        <button class="btn btn-danger" onclick="deleteScheduledTask(${task.id})">åˆ é™¤</button>
                        <button class="btn ${task.is_active ? 'btn-danger' : 'btn-primary'}" onclick="toggleScheduledTask(${task.id})">${task.is_active ? 'ç¦ç”¨' : 'å¯ç”¨'}</button>
                    </div>
                </div>
            `).join('');
        }

        // åˆ é™¤å®šæ—¶ä»»åŠ¡
        async function deleteScheduledTask(taskId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå®šæ—¶ä»»åŠ¡å—ï¼Ÿ')) return;
            try {
                const response = await fetch(`${API_BASE}/api/scheduled/${taskId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showAlert('å®šæ—¶ä»»åŠ¡åˆ é™¤æˆåŠŸ!', 'success');
                    loadScheduledTasks();
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                console.error('åˆ é™¤å®šæ—¶ä»»åŠ¡å¤±è´¥:', error);
                showAlert(`åˆ é™¤å®šæ—¶ä»»åŠ¡å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // å¯ç”¨/ç¦ç”¨å®šæ—¶ä»»åŠ¡
        async function toggleScheduledTask(taskId) {
            try {
                const response = await fetch(`${API_BASE}/api/scheduled/${taskId}/toggle`, {
                    method: 'PUT'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showAlert(result.message, 'success');
                    loadScheduledTasks();
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'æ“ä½œå¤±è´¥');
                }
            } catch (error) {
                console.error('åˆ‡æ¢å®šæ—¶ä»»åŠ¡çŠ¶æ€å¤±è´¥:', error);
                showAlert(`åˆ‡æ¢å®šæ—¶ä»»åŠ¡çŠ¶æ€å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åŠ è½½ä»»åŠ¡å†å²
        async function loadTaskHistory() {
            try {
                const response = await fetch(`${API_BASE}/api/tasks/`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const tasks = await response.json();
                updateTaskHistory(tasks);
            } catch (error) {
                console.error('åŠ è½½ä»»åŠ¡å†å²å¤±è´¥:', error);
                showAlert('åŠ è½½ä»»åŠ¡å†å²å¤±è´¥', 'error');
                document.getElementById('taskHistory').innerHTML = '<p>åŠ è½½ä»»åŠ¡å†å²å¤±è´¥</p>';
            }
        }

        // æ›´æ–°ä»»åŠ¡å†å²æ˜¾ç¤º
        function updateTaskHistory(tasks) {
            const container = document.getElementById('taskHistory');
            if (tasks.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #777; padding: 20px;">æš‚æ— ä»»åŠ¡å†å²</p>';
                return;
            }
            container.innerHTML = tasks.map(task => `
                <div class="result-item">
                    <h4>${task.task_name} - ${new Date(task.created_at).toLocaleString()}</h4>
                    <p><strong>å‘½ä»¤:</strong> ${task.command}</p>
                    <p><strong>æ‰§è¡ŒæœåŠ¡å™¨:</strong> ${task.servers.map(s => s.name).join(', ')}</p>
                    <p><strong>çŠ¶æ€:</strong> ${task.status}</p>
                    <button class="btn btn-primary" onclick="viewTaskDetails(${task.id})">æŸ¥çœ‹è¯¦æƒ…</button>
                </div>
            `).join('');
        }

        // æŸ¥çœ‹ä»»åŠ¡è¯¦æƒ…
        async function viewTaskDetails(taskId) {
            try {
                const response = await fetch(`${API_BASE}/api/tasks/${taskId}/`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const task = await response.json();
                
                // åˆ›å»ºæ¨¡æ€æ¡†
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 1000;
                `;
                
                const modalContent = document.createElement('div');
                modalContent.className = 'modal-content';
                modalContent.style = `
                    background-color: white;
                    padding: 20px;
                    border-radius: 5px;
                    width: 80%;
                    max-width: 800px;
                    max-height: 80%;
                    overflow-y: auto;
                `;
                
                modalContent.innerHTML = `
                    <h3>${task.task_name} - ${new Date(task.created_at).toLocaleString()}</h3>
                    <p><strong>å‘½ä»¤:</strong> ${task.command}</p>
                    <p><strong>æ‰§è¡ŒæœåŠ¡å™¨:</strong> ${task.servers.map(s => s.name).join(', ')}</p>
                    <p><strong>çŠ¶æ€:</strong> ${task.status}</p>
                    <p><strong>æ‰§è¡Œæ—¶é—´:</strong> ${task.execution_time || 'N/A'} ç§’</p>
                    <h4>æ‰§è¡Œç»“æœ</h4>
                    ${task.results.map(result => `
                        <div class="result-item">
                            <h5>${result.server.name} (${result.server.host})</h5>
                            <p><strong>çŠ¶æ€:</strong> ${result.exit_code === 0 ? 'æˆåŠŸ' : 'å¤±è´¥'}</p>
                            ${result.output ? `<pre>${result.output}</pre>` : ''}
                            ${result.error ? `<pre style="color: red;">${result.error}</pre>` : ''}
                        </div>
                    `).join('')}
                    <button class="btn btn-primary" onclick="document.body.removeChild(this.parentElement.parentElement)">å…³é—­</button>
                `;
                
                modal.appendChild(modalContent);
                document.body.appendChild(modal);
            } catch (error) {
                console.error('åŠ è½½ä»»åŠ¡è¯¦æƒ…å¤±è´¥:', error);
                showAlert('åŠ è½½ä»»åŠ¡è¯¦æƒ…å¤±è´¥', 'error');
            }
        }
    </script>
</body>

</html>
    